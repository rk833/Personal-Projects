<!-- templates/admin/edit_hotels.html -->

{% extends "admin/layout.html" %}

{% block title %}Edit Hotel - {{ hotel.hotel_name }}{% endblock %}

{% block content %}
<!-- Edit Hotel Container -->
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Edit Hotel</h1>
        <div>
            <a href="{{ url_for('admin_hotels') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Hotels
            </a>
            <a href="{{ url_for('admin_hotel_rooms', hotel_id=hotel.hotel_id) }}" 
               class="btn btn-info">
                <i class="fas fa-bed"></i> Manage Rooms
            </a>
        </div>
    </div>

    <!-- Edit Hotel Form -->
    <div class="row">
        <!-- Edit Form Card -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-md-6 mb-3">
                                <label for="hotel_name" class="form-label">Hotel Name *</label>
                                <input type="text" class="form-control" id="hotel_name" 
                                       name="hotel_name" value="{{ hotel.hotel_name }}" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="city_id" class="form-label">City *</label>
                                <select class="form-select" id="city_id" name="city_id" required>
                                    <option value="">Select City</option>
                                    {% for city in cities %}
                                    <option value="{{ city.city_id }}" 
                                            {% if city.city_id == hotel.city_id %}selected{% endif %}>
                                        {{ city.city_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Details -->
                            <div class="col-12 mb-3">
                                <label for="description" class="form-label">Description *</label>
                                <textarea class="form-control" id="description" name="description" 
                                          rows="4" required>{{ hotel.description }}</textarea>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="address" class="form-label">Address *</label>
                                <textarea class="form-control" id="address" name="address" 
                                          rows="2" required>{{ hotel.address }}</textarea>
                            </div>
                            
                            <!-- Specifications -->
                            <div class="col-md-4 mb-3">
                                <label for="total_rooms" class="form-label">Total Rooms *</label>
                                <input type="number" class="form-control" id="total_rooms" 
                                       name="total_rooms" value="{{ hotel.total_rooms }}" 
                                       required min="1">
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="star_rating" class="form-label">Star Rating *</label>
                                <select class="form-select" id="star_rating" name="star_rating" required>
                                    <option value="">Select Rating</option>
                                    {% for i in range(1, 8) %}
                                    <option value="{{ i }}" 
                                            {% if i == hotel.star_rating %}selected{% endif %}>
                                        {{ i }} Stars
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Features -->
                            <div class="col-12 mb-3">
                                <label for="features" class="form-label">Features</label>
                                <input type="text" class="form-control" id="features" 
                                       name="features" value="{{ hotel.features }}" 
                                       placeholder="e.g., WiFi, Pool, Gym">
                            </div>
                            
                            <!-- Timings -->
                            <div class="col-md-6 mb-3">
                                <label for="check_in_time" class="form-label">Check-in Time *</label>
                                <input type="time" class="form-control" id="check_in_time" 
                                       name="check_in_time" value="{{ hotel.check_in_time }}" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="check_out_time" class="form-label">Check-out Time *</label>
                                <input type="time" class="form-control" id="check_out_time" 
                                       name="check_out_time" value="{{ hotel.check_out_time }}" required>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="col-12 mb-3">
                                <label for="main_image" class="form-label">Main Image</label>
                                <input type="file" class="form-control" id="main_image" 
                                       name="main_image" accept="image/*">
                                <small class="text-muted">
                                    Leave empty to keep current image. Supported formats: JPG, JPEG, PNG, GIF. Max size: 5MB
                                </small>
                            </div>
                            
                            <!-- Submit Button -->
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Update Hotel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Hotel Info Card -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Hotel Information</h6>
                </div>
                <div class="card-body">
                    <!-- Current Image -->
                    <div class="text-center mb-3">
                        {% if hotel.main_image %}
                        <img src="{{ url_for('static', filename=hotel.main_image) }}" 
                             alt="{{ hotel.hotel_name }}" class="img-fluid rounded">
                        {% else %}
                        <img src="{{ url_for('static', filename='img/hotel-placeholder.jpg') }}" 
                             alt="No Image" class="img-fluid rounded">
                        {% endif %}
                    </div>

                    <!-- Stats -->
                    <div class="mb-3">
                        <h6 class="font-weight-bold">Statistics</h6>
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1">Total Rooms:</p>
                                <h4>{{ hotel.total_rooms }}</h4>
                            </div>
                            <div class="col-6">
                                <p class="mb-1">Rating:</p>
                                <h4>
                                    {% for i in range(hotel.star_rating|int) %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% endfor %}
                                </h4>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="mb-3">
                        <h6 class="font-weight-bold">Quick Links</h6>
                        <a href="{{ url_for('admin_hotel_rooms', hotel_id=hotel.hotel_id) }}" 
                           class="btn btn-info btn-sm btn-block mb-2">
                            <i class="fas fa-bed"></i> Manage Rooms
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Management Section -->
        <div class="col-12 mt-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Hotel Reviews</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="reviewsTable">
                            <thead>
                                <tr>
                                    <th>Guest</th>
                                    <th>Rating</th>
                                    <th>Comment</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for review in reviews %}
                                <tr>
                                    <td>{{ review.first_name }} {{ review.last_name }}</td>
                                    <td>
                                        {% for i in range(review.rating) %}
                                        <i class="fas fa-star text-warning"></i>
                                        {% endfor %}
                                        ({{ review.rating }}/5)
                                    </td>
                                    <td>{{ review.comment }}</td>
                                    <td>{{ review.review_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if review.is_verified %}
                                            <span class="badge bg-success text-white">Verified</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-info btn-sm view-review" 
                                                data-id="{{ review.review_id }}"
                                                data-guest="{{ review.first_name }} {{ review.last_name }}"
                                                data-rating="{{ review.rating }}"
                                                data-comment="{{ review.comment }}"
                                                data-date="{{ review.review_date.strftime('%Y-%m-%d') }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-primary btn-sm edit-review"
                                                data-id="{{ review.review_id }}"
                                                data-rating="{{ review.rating }}"
                                                data-comment="{{ review.comment }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm delete-review"
                                                data-id="{{ review.review_id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Review Modal -->
        <div class="modal fade" id="viewReviewModal" tabindex="-1" aria-labelledby="viewReviewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewReviewModalLabel">View Review</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Guest:</strong> <span id="viewGuest"></span></p>
                        <p><strong>Rating:</strong> <span id="viewRating"></span></p>
                        <p><strong>Comment:</strong> <span id="viewComment"></span></p>
                        <p><strong>Date:</strong> <span id="viewDate"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Review Modal -->
        <div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editReviewModalLabel">Edit Review</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editReviewForm">
                            <input type="hidden" id="editReviewId">
                            <div class="mb-3">
                                <label for="editRating" class="form-label">Rating</label>
                                <select class="form-select" id="editRating">
                                    <option value="1">1 Star</option>
                                    <option value="2">2 Stars</option>
                                    <option value="3">3 Stars</option>
                                    <option value="4">4 Stars</option>
                                    <option value="5">5 Stars</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editComment" class="form-label">Comment</label>
                                <textarea class="form-control" id="editComment" rows="4"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveReviewEdit">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Verify jQuery and Bootstrap are loaded -->
<script>
$(document).ready(function() {
    console.log('Document ready!');

    // View Review
    $('.view-review').on('click', function(e) {
        console.log('View button clicked!');
        e.preventDefault();
        const button = $(this);
        const reviewId = button.data('id');
        const guest = button.data('guest');
        const rating = button.data('rating');
        const comment = button.data('comment');
        const date = button.data('date');

        $('#viewGuest').text(guest);
        $('#viewRating').html('');
        for(let i = 0; i < rating; i++) {
            $('#viewRating').append('<i class="fas fa-star text-warning"></i> ');
        }
        $('#viewRating').append(` (${rating}/5)`);
        $('#viewComment').text(comment);
        $('#viewDate').text(date);
        
        const viewModal = new bootstrap.Modal(document.getElementById('viewReviewModal'));
        viewModal.show();
    });

    // Edit Review
    $('.edit-review').on('click', function(e) {
        console.log('Edit button clicked!');
        e.preventDefault();
        const button = $(this);
        const reviewId = button.data('id');
        const rating = button.data('rating');
        const comment = button.data('comment');
        
        $('#editReviewId').val(reviewId);
        $('#editRating').val(rating);
        $('#editComment').val(comment);
        
        const editModal = new bootstrap.Modal(document.getElementById('editReviewModal'));
        editModal.show();
    });

    // Save Review Edit
    $('#saveReviewEdit').on('click', function(e) {
        e.preventDefault();
        const reviewId = $('#editReviewId').val();
        const rating = $('#editRating').val();
        const comment = $('#editComment').val();

        if (!rating || !comment) {
            alert('Please fill in all fields');
            return;
        }

        $.ajax({
            url: `/admin/review/${reviewId}/edit`,
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            data: {
                rating: rating,
                comment: comment,
                csrf_token: '{{ csrf_token() }}'
            },
            success: function(response) {
                if (response.success) {
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editReviewModal'));
                    editModal.hide();
                    location.reload();
                } else {
                    alert(response.message || 'Error updating review');
                }
            },
            error: function(xhr) {
                alert('Error updating review');
                console.error(xhr.responseText);
            }
        });
    });

    // Delete Review
    $('.delete-review').on('click', function(e) {
        console.log('Delete button clicked!');
        e.preventDefault();
        const reviewId = $(this).data('id');
        
        if (confirm('Are you sure you want to delete this review?')) {
            $.ajax({
                url: `/admin/review/${reviewId}/delete`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                data: {
                    csrf_token: '{{ csrf_token() }}'
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message || 'Error deleting review');
                    }
                },
                error: function(xhr) {
                    alert('Error deleting review');
                    console.error(xhr.responseText);
                }
            });
        }
    });
});
</script>
{% endblock %}